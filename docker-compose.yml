version: '3.8'

services:
  # 1. Admin Panel & API
  web:
    build: .
    container_name: tg_shop_web
    restart: always
    ports:
      - "3000"
    env_file:
      - .env
    environment:
      - DATABASE_URL=file:/app/data/dev.db
      - NODE_OPTIONS=--dns-result-order=ipv4first
    volumes:
      - ./data:/app/data
      - ./public:/app/public
    command: node server.js

  # 2. Telegram Bot
  bot:
    build: .
    container_name: tg_shop_bot
    restart: always
    env_file:
      - .env
    environment:
      - DATABASE_URL=file:/app/data/dev.db
      - NODE_OPTIONS=--dns-result-order=ipv4first
    volumes:
      - ./data:/app/data
      - ./public:/app/public
    sysctls:
      - net.ipv6.conf.all.disable_ipv6=1
    # Run the bot using tsx directly from node_modules. 
    # Note: 'server.js' is for Next.js. We need to override command for bot.
    command: npx tsx scripts/start-bot.ts

  # 3. Caddy (Reverse Proxy + SSL)
  caddy:
    image: mirror.gcr.io/library/caddy:2-alpine
    restart: always
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - web

volumes:
  caddy_data:
  caddy_config:
